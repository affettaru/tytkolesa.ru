<? namespace Bitrix\Main\Security\W;$GLOBALS['____1875156260']= array(base64_decode(''.'dGl'.'t'.'ZQ=='),base64_decode(''.'dGltZQ='.'='),base64_decode('anNvbl'.'9k'.'ZWNvZGU'.'='),base64_decode('YX'.'JyYXlfb'.'WVyZ2U='),base64_decode('am9'.'p'.'bg=='),base64_decode(''.'am9'.'pbg=='),base64_decode('am9pbg=='),base64_decode('Y'.'XJyYXl'.'fcG9'.'w'),base64_decode(''.'YXJ'.'yYX'.'l'.'fc2hpZn'.'Q='),base64_decode('YX'.'Jy'.'Y'.'Xl'.'fc2'.'h'.'pZnQ='),base64_decode('Y'.'XJyY'.'Xlfc2hpZ'.'nQ'.'='),base64_decode('YXJyY'.'Xlfc2'.'hpZnQ='),base64_decode(''.'YXJ'.'yYX'.'lfbWVyZ2'.'U'.'='),base64_decode('aX'.'NfYXJyYXk'.'='),base64_decode('YX'.'JyYXlfbWVyZ2U='),base64_decode('aW'.'5f'.'YXJ'.'yYXk='),base64_decode('aW5fYXJyY'.'Xk='),base64_decode('aW5'.'fYX'.'JyYXk='),base64_decode(''.'aW5fY'.'XJyYXk'.'='),base64_decode('aW5'.'f'.'YXJ'.'y'.'YXk='),base64_decode(''.'dGl'.'t'.'ZQ=='),base64_decode('dGl'.'tZQ=='),base64_decode('YX'.'JyY'.'XlfbW'.'Fw'),base64_decode('Z'.'2'.'V0X2xv'.'Y'.'WRlZF9leHRlbnNpb25z'),base64_decode('anNv'.'bl9lbmNvZGU='),base64_decode('anNvbl9l'.'bm'.'NvZG'.'U'.'='),base64_decode('c'.'GhwdmVyc'.'2lvbg'.'=='),base64_decode('anNv'.'bl9lbmN'.'vZGU='),base64_decode('am9pbg=='));if(!function_exists(__NAMESPACE__.'\\___624200639')){function ___624200639($_1814630900){static $_319950722= false; if($_319950722 == false) $_319950722=array('V1dBTExfTE9DSw'.'==',''.'c'.'2Vjd'.'XJpdHk=',''.'RE'.'F'.'U'.'QQ==','eyI=','V1dBTExfTE9DS'.'w==','c2'.'V'.'jdXJpdHk=','U0VDV'.'V'.'JJVFlfV1dBTExfRV'.'hDRVBUSU9O','R'.'kFJT'.'F9'.'DSEV'.'DS'.'0lORw==','Q2'.'FuI'.'G5vdCBl'.'eGV'.'jdXRlIHd3YWxsI'.'HJ1bGVzO'.'iA=','IF'.'Ry'.'YWNlO'.'iA=','UkVRVU'.'VT'.'V'.'F9VUkk'.'=','a2V5cw==','d'.'mF'.'s'.'dWV'.'z','U0VDVVJJVFlfV'.'1dBTExfTU9ESUZZ','Lg'.'='.'=','U'.'0VDVVJ'.'JVFlfV'.'1dBTExfVU5'.'T'.'RVQ'.'=','Lg='.'=','U0VDVVJJVFlfV1dBTEx'.'fRVhJVA==',''.'Lg='.'=','Z2xvYmFs','a2V5cw==',''.'dmFsdWV'.'z','Z2V'.'0','Z2V0',''.'cG9zdA==',''.'cG9'.'z'.'dA'.'==','Y29va2ll','Y2'.'9va'.'2'.'l'.'l','cmVxdWVzd'.'A==','cmVxdWVzdA==','Z2xvYmFs','Z2xvYmFs',''.'bWFpbl9zZWM=','V1dB'.'TE'.'xf'.'QUN'.'UVUFMSVpFX'.'1J'.'VTE'.'VT','dg==','dmVyc2lvbg='.'=','aQ'.'==','aXNJbn'.'N0'.'YWx'.'s'.'Z'.'WQ'.'=','dg'.'==',''.'aW5p','b'.'W9kd'.'Wxlcw'.'==','bGljZW'.'5'.'zZ'.'Q='.'=','c'.'Ghw','dg='.'=',''.'Z'.'Xh0','c2VjdXJ'.'pdHk=',''.'ZGI=','dHlwZQ='.'=','Z'.'G'.'I'.'=','dm'.'Vyc2'.'lv'.'bg==','ZG'.'I=','d'.'HlwZQ='.'=','Z'.'GI=','d'.'HlwZQ==','dmVyc'.'2lvbg'.'='.'=','ZG'.'I=',''.'dmVyc2'.'lvb'.'g==',''.'ZW'.'52a'.'XJvb'.'m'.'1lb'.'n'.'Q'.'=','dm1fdmVy'.'c2l'.'vbg='.'=','dm0=','d'.'g==',''.'ZW5'.'2'.'aXJv'.'b'.'m1lbn'.'Q=','dm1fdmVy'.'c'.'2lv'.'b'.'g==','c29ja'.'2V'.'0VGltZW91'.'dA'.'==','c3RyZWFtVGltZW91dA='.'=','K'.'C'.'c'.'=','ZGF0YQ==','J'.'yw'.'gJw==',''.'bW9kdWxl','Jy'.'wgJw==','bW9kdWx'.'lX'.'3Z'.'l'.'c'.'n'.'Npb24=','Jyk'.'=','LCA=',''.'U0VDVVJJVFlfV1d'.'B'.'TE'.'xfRVhDRVBUS'.'U9O','bWFpb'.'g==','RkF'.'JTF'.'9SRUZSRVN'.'ISU5H','Q'.'2'.'Fu'.'IG5vdCBy'.'Z'.'WZ'.'yZXN'.'oIHd3YWx'.'sI'.'HJ1bGVz'.'OiA'.'=','IFR'.'yYWNlOiA'.'=','ZGF0'.'Y'.'Q==','e'.'yI=','LS0'.'tLS1CRUdJTiBQVUJMSUMgS0V'.'ZLS0tLS0=','C'.'k1JSUJJakFOQmdrc'.'Whr'.'aU'.'c5dzBC'.'QVFFRkFBT0NBUThB'.'TUl'.'JQk'.'NnS0NBU'.'UVBcT'.'h'.'RRTBIam1ISlVTdF'.'dW'.'Nm'.'4wemEKU'.'lZvTH'.'gwM'.'kt6Ym'.'ZyYlMvUDZzV'.'2F4V'.'H'.'p3OF'.'Nl'.'R1R0Y'.'lRDT3JwSGk1U'.'UY2T1J5'.'a'.'l'.'ovWHh6L0tMVTF'.'HYm9mOU'.'N'.'aMwo0ejdT'.'a3F'.'VdDY2aWJ'.'Ydk9'.'GQng0Z'.'n'.'cvQVBQU'.'kdEcX'.'RtM'.'G5EM2Zn'.'R3N1M1JlUGd'.'3MjlpOCt2bTdtd'.'EJL'.'SlV'.'Zb'.'DR'.'yClZwY'.'jZz'.'Zlp'.'FVDlLRW'.'I2VDFIRFltRXZj'.'M'.'WhxL2lpdX'.'l'.'4T'.'HJaWmk1UTZVZ'.'mY'.'0'.'V'.'UV2V'.'Ekr'.'Njhzc'.'0ZS'.'a1E'.'rb3dUUnkKZU9'.'J'.'TWJGaE0vVVRt'.'ZlZZYlRSRn'.'k'.'yb1V'.'RO'.'FdNemEybk'.'o1'.'U'.'2Foe'.'mkxVUtPMWpBa'.'lhUU'.'FJyemM3QWp1'.'N'.'jM5aj'.'FP'.'MApwc'.'HFmbTV4'.'Z1dsRkFKa'.'0hRVGdiZG'.'Q1QVdx'.'REZRa3Q5SE'.'trWStUb'.'mZCTEdWTXZ'.'W'.'e'.'VB3VEhOV1FZ'.'QXc0eH'.'BnL'.'3d'.'B'.'Clp3SU'.'RBUUFCCi0'.'tL'.'S0tRU5'.'EIFBVQkx'.'JQyBLRVkt'.'L'.'S0'.'tLQ==');return base64_decode($_319950722[$_1814630900]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_1092239879= 'https://wwall.bitrix.info/rules.php'; protected $_103310153= true; public function handle(){ try{  $_1741041940= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1741041940)){ return;}  $_2130912452= Cache::createInstance(); $_123250902= false; if($_2130912452->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_2111240139= $_2130912452->getVars(); if($GLOBALS['____1875156260'][0]()- $_2111240139> round(0+20)){  $_150432930= Application::getConnection(); $_657180407= RuleRecordTable::getTableName(); $_150432930->truncateTable($_657180407); RuleRecordTable::cleanCache(); $_2130912452->clean(___624200639(0), ___624200639(1));}} elseif($_2130912452->startDataCache()){  $_2130912452->endDataCache($GLOBALS['____1875156260'][1]()); $_123250902= true;} foreach($_1741041940 as $_486448358){ $_1026563011= new PublicKeyCipher; $_2048184152= $_1026563011->decrypt($_486448358[___624200639(2)], static::__247060406()); if(!str_starts_with($_2048184152, ___624200639(3))){ continue;} $_2082005679= $GLOBALS['____1875156260'][2]($_2048184152, true); if(!empty($_2082005679)){ $_1164581231= Rule::make($_2082005679); $_830085447= $this->handleRule($_1164581231); $this->applyHandlingResults($_830085447);}}  if($_123250902){ $_2130912452->clean(___624200639(4), ___624200639(5));}} catch(\Throwable $_799040595){ $this->logEvent( ___624200639(6), ___624200639(7), ___624200639(8). $_799040595->getMessage(). ___624200639(9). $_799040595->getTraceAsString());}}  public function handleRule(Rule $_1164581231): array{ $_830085447=[]; if($_1164581231->matchPath($_SERVER[___624200639(10)])){  $_189402080= $this->getContextElements($_1164581231->getContext()); foreach($_189402080 as $_1683507821 => &$_1342759339){ $_830085447= $GLOBALS['____1875156260'][3]($_830085447, $this->recursiveContextKeyHandle($_1683507821, $_1342759339,[], $_1164581231));}} return $_830085447;}  public function applyHandlingResults(array $_830085447){ $_189402080= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_830085447 as $_562869557){ $_1342759339=& $_189402080[$_562869557->getContextName()]; $_1980267248= $_562869557->getRuleResult(); $_1164581231= $_562869557->getRule(); if($_1980267248 instanceof ModifyResult){ if($_1164581231->getProcess() === ___624200639(11)){  static::rewriteContextKey( $_562869557->getContextName(), $_1342759339, $_562869557->getContextKey(), $_1980267248->getCleanValue());} elseif($_1164581231->getProcess() === ___624200639(12)){ static::rewriteContextValue( $_562869557->getContextName(), $_1342759339, $_562869557->getContextKey(), $_1980267248->getCleanValue());} $this->logEvent( ___624200639(13), $_562869557->getContextName(), $GLOBALS['____1875156260'][4](___624200639(14), $_562869557->getContextKey()));} elseif($_1980267248 instanceof CheckResult &&!$_1980267248->isSuccess()){ if($_1980267248->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_562869557->getContextName(), $_1342759339, $_562869557->getContextKey(),); $this->logEvent( ___624200639(15), $_562869557->getContextName(), $GLOBALS['____1875156260'][5](___624200639(16), $_562869557->getContextKey()));} elseif($_1980267248->getAction() === RuleAction::EXIT){ $this->logEvent( ___624200639(17), $_562869557->getContextName(), $GLOBALS['____1875156260'][6](___624200639(18), $_562869557->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_103310153= false;} protected function rewriteContextKey($_1683507821, &$_1342759339, $_691777477, $_1417628671){ $_754789347= $_691777477;  $GLOBALS['____1875156260'][7]($_754789347); $_754789347[]= $_1417628671; if($_1683507821 === ___624200639(19)){ $_1896152369= $GLOBALS['____1875156260'][8]($_691777477); $GLOBALS['____1875156260'][9]($_754789347); if(empty($_691777477)){ $GLOBALS[$_1417628671]= $GLOBALS[$_1896152369]; unset($GLOBALS[$_1896152369]);} else{ $_1342759339=& $GLOBALS[$_1896152369]; $_1496756303= ArrayHelper::getByNestedKey($_1342759339, $_691777477);  ArrayHelper::setByNestedKey($_1342759339, $_754789347, $_1496756303);  ArrayHelper::unsetByNestedKey($_1342759339, $_691777477);}} else{ $_1496756303= ArrayHelper::getByNestedKey($_1342759339, $_691777477);  ArrayHelper::setByNestedKey($_1342759339, $_754789347, $_1496756303);  ArrayHelper::unsetByNestedKey($_1342759339, $_691777477);}} protected function rewriteContextValue($_1683507821, &$_1342759339, $_1664501606, $_1496756303){ if($_1683507821 === 'global'){ $_1896152369= $GLOBALS['____1875156260'][10]($_1664501606); if(empty($_1664501606)){ $GLOBALS[$_1896152369]= $_1496756303;} else{ $_1342759339=& $GLOBALS[$_1896152369]; ArrayHelper::setByNestedKey($_1342759339, $_1664501606, $_1496756303);}} else{  ArrayHelper::setByNestedKey($_1342759339, $_1664501606, $_1496756303);}} protected function unsetContextValue($_1683507821, &$_1342759339, $_1664501606){ if($_1683507821 === 'global'){ $_1896152369= $GLOBALS['____1875156260'][11]($_1664501606); if(empty($_1664501606)){ unset($GLOBALS[$_1896152369]);} else{ $_1342759339=& $GLOBALS[$_1896152369]; ArrayHelper::unsetByNestedKey($_1342759339, $_1664501606);}} else{ ArrayHelper::unsetByNestedKey($_1342759339, $_1664501606);}}  protected function recursiveContextKeyHandle(string $_1683507821, array &$_1342759339, array $_978229474, Rule $_1164581231): array{  $_830085447=[]; foreach($_1342759339 as $_1974784125 => $_1496756303){ $_1664501606= $GLOBALS['____1875156260'][12]($_978229474,[$_1974784125]); if($_1164581231->matchKey($_1664501606)){  if($_1164581231->getProcess() === ___624200639(20)){ $_1980267248= $_1164581231->evaluate($_1974784125);} elseif($_1164581231->getProcess() === ___624200639(21)){ $_1980267248= $_1164581231->evaluateValue($_1496756303);}  if(!empty($_1980267248) && $_1980267248 instanceof RuleResult){ $_830085447[]= new HandlingResult($_1683507821, $_1664501606, $_1980267248, $_1164581231);}}  if($GLOBALS['____1875156260'][13]($_1496756303)){ $_830085447= $GLOBALS['____1875156260'][14]($_830085447, $this->recursiveContextKeyHandle( $_1683507821, $_1342759339[$_1974784125], $_1664501606, $_1164581231));}} return $_830085447;} protected function getContextElements(array $_68681677){ $_1840653235=[]; if($GLOBALS['____1875156260'][15](___624200639(22), $_68681677, true)){ $_1840653235[___624200639(23)]= &$_GET;} if($GLOBALS['____1875156260'][16](___624200639(24), $_68681677, true)){ $_1840653235[___624200639(25)]= &$_POST;} if($GLOBALS['____1875156260'][17](___624200639(26), $_68681677, true)){ $_1840653235[___624200639(27)]= &$_COOKIE;} if($GLOBALS['____1875156260'][18](___624200639(28), $_68681677, true)){ $_1840653235[___624200639(29)]= &$_REQUEST;} if($GLOBALS['____1875156260'][19](___624200639(30), $_68681677, true)){ $_1840653235[___624200639(31)]= $GLOBALS;} return $_1840653235;} public static function refreshRules(){ try{ $_1569755263= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1875156260'][20]()- $_1569755263)< static::CACHE_RULES_TTL){ return;} Option::set(___624200639(32), ___624200639(33), $GLOBALS['____1875156260'][21]()); $_1042532232= null;  $_263445132= $GLOBALS['____1875156260'][22](function($_1818918549){ return[___624200639(34) => $_1818918549[___624200639(35)], ___624200639(36) => (int) $_1818918549[___624200639(37)]];}, ModuleManager::getModulesFromDisk());  $_640413738=[]; foreach($GLOBALS['____1875156260'][23]() as $_1969074927){ $_1478590745= new ReflectionExtension($_1969074927); $_640413738[$_1969074927]=[ ___624200639(38) => $_1478590745->getVersion(), ___624200639(39) => $_1478590745->getINIEntries()];} $_1282678632=[ ___624200639(40) => $GLOBALS['____1875156260'][24]($_263445132), ___624200639(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___624200639(42) => $GLOBALS['____1875156260'][25]([ ___624200639(43) => $GLOBALS['____1875156260'][26](), ___624200639(44) => $_640413738])]; if(Loader::includeModule(___624200639(45))){ $_326167680= CSecuritySystemInformation::getSystemInformation(); if(isset($_326167680[___624200639(46)][___624200639(47)]) && isset($_326167680[___624200639(48)][___624200639(49)])){ $_1282678632[___624200639(50)]=[ ___624200639(51) => $_326167680[___624200639(52)][___624200639(53)], ___624200639(54) => $_326167680[___624200639(55)][___624200639(56)]];} if(isset($_326167680[___624200639(57)][___624200639(58)])){ $_1282678632[___624200639(59)]=[___624200639(60) => $_326167680[___624200639(61)][___624200639(62)]];}}  $_604122853= new HttpClient([ ___624200639(63) => round(0+1.25+1.25+1.25+1.25), ___624200639(64) => round(0+1+1+1+1+1)]); $_1138660885= $_604122853->post( static::$_1092239879, $_1282678632); if($_604122853->getStatus() == round(0+100+100) &&!empty($_1138660885)){ $_1042532232= Json::decode($_1138660885);}  if($_1042532232 !== null){ $_150432930= Application::getConnection(); $_657180407= RuleRecordTable::getTableName(); if(!empty($_1042532232)){ foreach($_1042532232 as $_1055209056){ if(!static::checkRuleSign($_1055209056)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1875156260'][27]($_1055209056));}}}  $_150432930->truncateTable($_657180407);  if(!empty($_1042532232)){ $_1093117690=[]; foreach($_1042532232 as $_1055209056){ $_1093117690[]= ___624200639(65). $_150432930->getSqlHelper()->forSql($_1055209056[___624200639(66)]). ___624200639(67). $_150432930->getSqlHelper()->forSql($_1055209056[___624200639(68)]). ___624200639(69). $_150432930->getSqlHelper()->forSql($_1055209056[___624200639(70)]). ___624200639(71);} $_615574572= $GLOBALS['____1875156260'][28](___624200639(72), $_1093117690);  $_150432930->query("INSERT INTO {$_657180407} (DATA, MODULE, MODULE_VERSION) VALUES {$_615574572}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_799040595){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___624200639(73), ___624200639(74), ___624200639(75), ___624200639(76). $_799040595->getMessage(). ___624200639(77). $_799040595->getTraceAsString());}} protected static function checkRuleSign($_1164581231){ $_1026563011= new PublicKeyCipher; $_2082005679= $_1026563011->decrypt($_1164581231[___624200639(78)], static::__247060406()); return str_starts_with($_2082005679, ___624200639(79));} private static function __247060406(){ $_895845052= ''; $_895845052 .= ___624200639(80); $_895845052 .= ___624200639(81); return $_895845052;} protected function logEvent($_2082498780, $_638707601, $_1113537133){ if($this->_103310153){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_2082498780, 'main', $_638707601, $_1113537133);}}}?>